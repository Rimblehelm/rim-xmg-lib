name: Auto-create Release Environment

# Run when a repo is created; we'll only run when the repository is a template
on:
  repository:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-from-template:
    if: github.event.repository.is_template == true
    runs-on: ubuntu-latest
    env:
      ADMIN_TOKEN: ${{ secrets.ADMIN_GITHUB_TOKEN }}
      FALLBACK_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GH CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh
      - name: Setup GH token for environment creation
        run: |
          if [ -n "${ADMIN_TOKEN}" ]; then
            echo "Using ADMIN_GITHUB_TOKEN from repository secrets (recommended)."
            echo "${ADMIN_TOKEN}" | gh auth login --with-token
          else
            echo "ADMIN_GITHUB_TOKEN is not set; falling back to GITHUB_TOKEN (may not have permission)."
            echo "${FALLBACK_TOKEN}" | gh auth login --with-token
          fi

      - name: Show token owner
        run: |
          gh api /user -q .login || echo 'unknown'
        env:
          GH_TOKEN: ${{ env.ADMIN_TOKEN }}

      - name: Show token scopes
        run: |
          curl -sI -H "Authorization: token ${ADMIN_TOKEN}" https://api.github.com/user | sed -n '1,120p' || true
        env:
          ADMIN_TOKEN: ${{ env.ADMIN_TOKEN }}

      - name: Show repo permission for token user
        run: |
          USER=$(gh api /user -q .login)
          gh api "/repos/${{ github.repository }}/collaborators/${USER}/permission" -q .permission || true
        env:
          ADMIN_TOKEN: ${{ env.ADMIN_TOKEN }}

      - name: Validate ADMIN_GITHUB_TOKEN for auto-create
        run: |
          # The auto-create workflow requires elevated permissions; fail early with a clear message
          if [ -z "${ADMIN_TOKEN}" ]; then
            echo "ERROR: ADMIN_GITHUB_TOKEN is not set. To automatically create environments on repo creation, add a repository secret ADMIN_GITHUB_TOKEN with a personal access token that has the 'repo' scope."
            exit 1
          fi
          fi

      - name: Create release and docs environments
        run: |
          chmod +x ./scripts/create-environment.sh
          # Create release env
          ./scripts/create-environment.sh release ""
          # Create docs env to gate GitHub Pages deployment
          ./scripts/create-environment.sh docs ""
