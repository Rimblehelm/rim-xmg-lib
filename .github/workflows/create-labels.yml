name: Create default labels

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]
  # repository dispatch is a more widely supported manual bootstrap trigger
  # and can be invoked via the REST API. Use it as a fallback in case the
  # `repository` event (created) is not supported in the repo environment.
  repository_dispatch: {}
  # Also try the `repository` event for immediate bootstrapping on repo creation
  # (some environments or organizations support `repository`->`created`).
  # NOTE: `repository` may not be supported in all environments. Keep the
  # repository_dispatch trigger for wider compatibility, and avoid the
  # `repository` event if your Actions linter flags it as "Unexpected value".
  schedule:
    - cron: '0 3 * * 0' # weekly at 03:00 UTC on Sundays

permissions:
  issues: write
  contents: read

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: "Debug: show repository and actor"
        uses: actions/github-script@v7
        with:
          script: |
            console.log('context.repo:', JSON.stringify(context.repo));
            console.log('actor:', context.actor);
            // Try a basic repository API call to ensure token works
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            try {
              await github.rest.repos.get({ owner, repo });
              console.log('Repo access OK');
            } catch (err) {
              console.error('Repo access failed', err.message || err);
              throw err;
            }

      - name: "Create labels"
        uses: actions/github-script@v7
        with:
          script: |
            // Read labels.json directly from the repository using the REST API
            // This avoids relying on actions/checkout and works even when the
            // checkout fails due to permission behavior for the trigger.
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let data;
            try {
              const resp = await github.rest.repos.getContent({ owner, repo, path: '.github/labels.json' });
              data = resp.data;
            } catch (err) {
              console.error('Error reading .github/labels.json via REST API', err.status || err.message || err);
              throw err;
            }
            const content = Buffer.from(data.content, 'base64').toString('utf8');
            const labels = JSON.parse(content);
            // Determine if this is a first-run by checking if the repository
            // already has labels. If none are present, we will create them all.
            const existing = await github.paginate(github.rest.issues.listLabelsForRepo, { owner, repo });
            const firstRun = existing.length === 0;

            if (firstRun) {
              console.log('No labels found; performing bootstrap label creation');
            }

            for (const label of labels) {
              try {
                // Try to get label first
                await github.rest.issues.getLabel({ owner, repo, name: label.name });
                // If exists, update
                await github.rest.issues.updateLabel({ owner, repo, name: label.name, color: label.color.replace('#', ''), description: label.description });
              } catch (err) {
                // If label not found, create it
                if (err.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name: label.name, color: label.color.replace('#', ''), description: label.description });
                } else {
                  throw err;
                }
              }
            }
