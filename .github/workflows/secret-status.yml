name: Secret status

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    tags:
      - 'v*'
  # Also update status when a release is published
  release:
    types: [published]
  # Also update on tag pushes (e.g., version tags) - handled under 'push:' above
  schedule:
    - cron: '0 4 * * 1' # weekly check every Monday at 04:00 UTC

permissions:
  contents: write
  actions: read

jobs:
  update-secrets-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check repository secrets
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const resp = await github.rest.actions.listRepoSecrets({ owner, repo });
            const secrets = resp.data.secrets.map(s => s.name);
            const hasNpm = secrets.includes('NPM_TOKEN');
            const hasCoveralls = secrets.includes('COVERALLS_REPO_TOKEN');

            // Compose JSON for shields.io endpoint
            const payload = {
              schemaVersion: 1,
              label: 'publish',
              message: hasNpm ? 'OK' : 'Missing NPM_TOKEN',
              color: hasNpm ? 'brightgreen' : 'red'
            };

            const md = `# Secrets status\n\n- NPM_TOKEN: ${hasNpm ? 'present' : 'missing'}\n- COVERALLS_REPO_TOKEN: ${hasCoveralls ? 'present' : 'missing'}\n`;

            const fs = require('fs');
            fs.writeFileSync('docs/SECRETS_STATUS.json', JSON.stringify(payload, null, 2));
            fs.writeFileSync('docs/SECRETS_STATUS.md', md);

      - name: Check NPM token type (warn-only)
        id: npm_check
        uses: ./.github/actions/check-npm-token
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Append npm-check to SECRETS_STATUS
        env:
          NPM_CHECK: ${{ steps.npm_check.outputs.result || '' }}
        run: |
          set -e
          echo "NPM_CHECK: $NPM_CHECK" >> docs/SECRETS_STATUS.md
          node -e "const fs=require('fs'); const p=JSON.parse(fs.readFileSync('docs/SECRETS_STATUS.json','utf8')); p.npmCheck=process.env.NPM_CHECK || 'none'; fs.writeFileSync('docs/SECRETS_STATUS.json', JSON.stringify(p,null,2));"

      - name: Validate generated JSON
        run: |
          node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync('docs/SECRETS_STATUS.json','utf8')); if(typeof j.schemaVersion!=='number') throw 'schemaVersion missing'; if(!j.label) throw 'label missing'; if(!j.message) throw 'message missing';"

      - name: Commit status files (requires STATUS_COMMIT_TOKEN)
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'release' }}
        env:
          STATUS_COMMIT_TOKEN: ${{ secrets.STATUS_COMMIT_TOKEN }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "github-actions"
          git add docs/SECRETS_STATUS.json docs/SECRETS_STATUS.md || true
          git commit -m "ci: update secrets status" || true
          # Use token to push. This ensures commits happen only when token is provided.
          if [ -z "${STATUS_COMMIT_TOKEN:-}" ]; then
            echo "STATUS_COMMIT_TOKEN not provided; skipping commit push."
            exit 0
          fi
          git remote set-url origin https://x-access-token:${STATUS_COMMIT_TOKEN}@github.com/${GITHUB_REPOSITORY}
          git push origin HEAD:main || true
