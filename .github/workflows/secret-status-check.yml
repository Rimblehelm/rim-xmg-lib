name: Secret Status Check

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  release:
    types: [published]
  schedule:
    - cron: '0 6 * * 1' # weekly

permissions:
  checks: write
  statuses: write
  contents: read

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node for script run
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine head SHA to attach status
        id: head
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Default fallback to the default branch head
            async function getDefaultBranchSha() {
              const repoResp = await github.rest.repos.get({ owner, repo });
              const branch = repoResp.data.default_branch;
              const branchResp = await github.rest.repos.getBranch({ owner, repo, branch });
              return branchResp.data.commit.sha;
            }

            let headSha = context.sha;
            if (context.eventName === 'release' && context.payload.release && context.payload.release.target_commitish) {
              try {
                const branchResp = await github.rest.repos.getBranch({ owner, repo, branch: context.payload.release.target_commitish });
                headSha = branchResp.data.commit.sha;
              } catch (err) {
                headSha = await getDefaultBranchSha();
              }
            } else if (!headSha) {
              headSha = await getDefaultBranchSha();
            }

            return headSha;

      - name: Check NPM token via local action
        id: npm_check
        uses: ./.github/actions/check-npm-token
        with:
          npm-token: ${{ secrets.NPM_TOKEN }}

      - name: Check Coveralls token
        id: coveralls_check
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: |
          chmod +x ./scripts/check-coveralls-token.js || true
          node ./scripts/check-coveralls-token.js && echo "result=success" >> $GITHUB_OUTPUT || echo "result=fail" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create secrets status check and commit status
        uses: actions/github-script@v7
        env:
          NPM_CHECK_RESULT: ${{ steps.npm_check.outputs.result || '' }}
          COVERALLS_CHECK_RESULT: ${{ steps.coveralls_check.outputs.result || '' }}
          # Pass secrets as env to infer presence without calling restricted API
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = '${{ steps.head.outputs.result }}' || context.sha;

            // Infer presence based on environment injection (works with GITHUB_TOKEN)
            const hasNpm = !!process.env.NPM_TOKEN;
            const hasCoveralls = !!process.env.COVERALLS_REPO_TOKEN;

            const summary = `Secrets status:\n- NPM_TOKEN: ${hasNpm ? 'present' : 'missing'}\n- COVERALLS_REPO_TOKEN: ${hasCoveralls ? 'present' : 'missing'}`;

            const npmTokenCheck = (typeof process.env.NPM_CHECK_RESULT !== 'undefined') ? process.env.NPM_CHECK_RESULT : 'NPM_TOKEN not present';
            const coverallsCheck = (typeof process.env.COVERALLS_CHECK_RESULT !== 'undefined') ? process.env.COVERALLS_CHECK_RESULT : 'COVERALLS_REPO_TOKEN not present';

            // Create a check run with details (with retry in case commit isn't indexed yet)
            async function createCheckWithRetry(attempts = 5, delayMs = 3000) {
              let lastErr;
              for (let i = 0; i < attempts; i++) {
                try {
                  await github.rest.checks.create({
                    owner,
                    repo,
                    name: 'Secrets Status',
                    head_sha: sha,
                    status: 'completed',
                    conclusion: hasNpm ? 'success' : 'failure',
                    output: {
                      title: 'Secrets Status',
                      summary: `${summary}\n\n${npmTokenCheck}`,
                      text: `Coveralls token check result: ${coverallsCheck}`
                    }
                  });
                  return; // success
                } catch (err) {
                  lastErr = err;
                  if (i < attempts - 1) {
                    await new Promise(r => setTimeout(r, delayMs));
                  }
                }
              }
              throw lastErr;
            }

            try {
              await createCheckWithRetry();
            } catch (err) {
              core.warning(`checks.create failed: ${err?.message || err}`);
            }

            // Create a commit status for the same commit (very visible in PRs)
            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: hasNpm ? 'success' : 'failure',
              context: 'Secrets Status',
              description: hasNpm ? npmTokenCheck : 'NPM_TOKEN missing'
            });
