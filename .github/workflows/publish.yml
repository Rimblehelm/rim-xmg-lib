name: Publish

on:
  release:
    types: [published]
  # Keep `workflow_dispatch` for manual/pipeline runs
  workflow_dispatch:
    inputs:
      use_npm:
        description: 'Publish to npmjs.org instead of GitHub Packages'
        required: false
        default: 'false'
      use_oidc:
        description: 'When publishing to npmjs.org set to true to use Trusted Publishing (OIDC). If true, no NPM token is required (must configure Trusted Publisher on npmjs).'
        required: false
        default: 'true'

# Quick notes for maintainers:
# - Inputs:
#   - use_npm: when `true`, the workflow will attempt to publish to npmjs.org instead of GitHub Packages.
#   - use_oidc: when `true` and `use_npm==true`, the workflow will try Trusted Publishing (OIDC) for npmjs; no
#     `NPM_TOKEN` secret is required. If `use_oidc` is `false`, an `NPM_TOKEN` Automation token is required.
#
# - Secrets:
#   - `GITHUB_TOKEN` is provided automatically by GitHub Actions and is used to publish to GitHub Packages.
#   - `NPM_TOKEN` (optional): set this only if you want to publish to npmjs.org using token-based auth
#     (`use_npm=true` and `use_oidc=false`). Create an Automation token on npmjs.com and store it as this secret.
#
# For details and troubleshooting steps look at `README.md` and `docs/SECRETS.md`.

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  publish:
    name: Publish package to GitHub Packages
    runs-on: ubuntu-latest
    environment: release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com/'

      - name: Install dependencies
        run: npm ci

      - name: Ensure npm supports Trusted Publishing (OIDC)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' && github.event.inputs.use_oidc == 'true' }}
        run: |
          echo "node: $(node --version)"
          echo "npm: $(npm --version)"
          # trusted publishing requires npm 11.5.1 or later
          npm install -g npm@11.5.1
          echo "upgraded npm: $(npm --version)"

      - name: Build
        run: npm run build

      - name: Extract package version
        id: pkg_version
        run: echo "version=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT

      - name: Check if version already published (GitHub Packages)
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.use_npm != 'true' }}
        env:
          PUBLISH_REGISTRY: https://npm.pkg.github.com/
        run: |
          PKG_NAME=$(node -p 'require("./package.json").name')
          VERSION=${{ steps.pkg_version.outputs.version }}
          echo "Checking if $PKG_NAME@$VERSION exists on GitHub Packages..."
          EXISTS=$(npm view "$PKG_NAME@$VERSION" version --registry "$PUBLISH_REGISTRY" 2>/dev/null || echo "")
          if [ "$EXISTS" = "$VERSION" ]; then
            echo "Version $VERSION already published to GitHub Packages."
            echo "If you intend to publish a new build, bump the version in package.json (e.g. npm version patch) before creating a release."
            exit 1
          fi
          echo "Version $VERSION not found on GitHub Packages. Proceeding."

      - name: Check if version already published (npmjs.org)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        env:
          PUBLISH_REGISTRY: https://registry.npmjs.org/
        run: |
          PKG_NAME=$(node -p 'require("./package.json").name')
          VERSION=${{ steps.pkg_version.outputs.version }}
          echo "Checking if $PKG_NAME@$VERSION exists on npmjs.org..."
          EXISTS=$(npm view "$PKG_NAME@$VERSION" version --registry "$PUBLISH_REGISTRY" 2>/dev/null || echo "")
          if [ "$EXISTS" = "$VERSION" ]; then
            echo "Version $VERSION already published to npmjs.org."
            echo "Bump the version (npm version patch/minor/major) and re-run the workflow."
            exit 1
          fi
          echo "Version $VERSION not found on npmjs.org. Proceeding."

      - name: Determine publish registry
        run: |
          # Default to GitHub Packages token
          echo "PUBLISH_REGISTRY=https://npm.pkg.github.com/" >> $GITHUB_ENV
          echo "NODE_AUTH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Determine npm publish config (manual dispatch only)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Default to GitHub Packages token
          echo "PUBLISH_REGISTRY=https://npm.pkg.github.com/" >> $GITHUB_ENV
          echo "NODE_AUTH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

          # If this workflow was manually dispatched with use_npm=true, switch to npmjs registry
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.use_npm }}" = "true" ]; then
            echo "PUBLISH_REGISTRY=https://registry.npmjs.org/" >> $GITHUB_ENV
            if [ "${{ github.event.inputs.use_oidc }}" = "true" ]; then
              echo "Using Trusted Publishing (OIDC) for npmjs.org — no NPM_TOKEN required (ensure Trusted Publisher on npmjs is configured)."
              else
              if [ -z "$NPM_TOKEN" ]; then
                echo "ERROR: NPM_TOKEN must be set to publish to npmjs.org. Add it in Settings → Secrets and variables → Actions.";
                exit 1;
              fi
              echo "NODE_AUTH_TOKEN=$NPM_TOKEN" >> $GITHUB_ENV
            fi
          fi

      - name: Validate required secrets (manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' && github.event.inputs.use_oidc != 'true' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          chmod +x ./scripts/validate-secrets.sh || true
          ./scripts/validate-secrets.sh NPM_TOKEN

      - name: Fail early when npm publish requested but NPM_TOKEN missing
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' && github.event.inputs.use_oidc != 'true' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "ERROR: Publishing to npmjs.org requested via 'use_npm=true' and OIDC is disabled (use_oidc=false), but NPM_TOKEN is not set in repository secrets.";
            echo "Please either enable OIDC (use_oidc=true) or configure an Automation token on npmjs.com and add it to GitHub as 'NPM_TOKEN'";
            exit 1
          fi

      - name: Check NPM token type (automation) using local action
        id: npm_check_action
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' && github.event.inputs.use_oidc != 'true' }}
        uses: ./.github/actions/check-npm-token
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Fail when NPM token is not Automation type
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' && github.event.inputs.use_oidc != 'true' && !contains(steps.npm_check_action.outputs.result, 'automation token found') }}
        run: |
          echo "ERROR: NPM_TOKEN is present but does not appear to be an Automation token according to npm token list.";
          echo "Fix: create an npm Automation token in https://www.npmjs.com/settings/access-tokens and add it to GitHub Secrets as NPM_TOKEN.";
          exit 1

      - name: Configure npm auth for registry
        run: |
          if [ "$PUBLISH_REGISTRY" = "https://registry.npmjs.org/" ]; then
            if [ "${{ github.event.inputs.use_oidc }}" = "true" ]; then
              echo "Using Trusted Publishing (OIDC); skipping authentication token set for npmjs.org.";
            else
              echo "Configuring npm auth for npmjs.org";
              npm config set //registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN;
            fi
          else
            echo "Configuring npm auth for GitHub Packages";
            npm config set //npm.pkg.github.com/:_authToken=$NODE_AUTH_TOKEN;
          fi

      - name: Check NPM token (whoami)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' && github.event.inputs.use_oidc != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
        run: |
          echo "Checking npm authentication at $PUBLISH_REGISTRY"
          npm whoami --registry "$PUBLISH_REGISTRY" || (echo "ERROR: npm whoami failed — your NPM_TOKEN may be invalid or lack publish access for this package"; exit 1)

      - name: Verify NPM token type is Automation (CI-only)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' && github.event.inputs.use_oidc != 'true' }}
        env:
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
        run: |
          echo "Verifying NPM token type on $PUBLISH_REGISTRY"
          # npm token list returns tokens for the authenticated user. Ensure the token in use is type 'automation'.
          # We avoid printing the list directly to keep tokens and IDs private.
          if ! npm token list --json --registry "$PUBLISH_REGISTRY" 2>/dev/null | node -e "const fs=require('fs'); const s=fs.readFileSync(0,'utf8'); let tokens=(s?JSON.parse(s):null); if(!tokens) process.exit(1); if(Array.isArray(tokens) && tokens.some(t=>t.type==='automation')) process.exit(0); if(typeof tokens==='object' && Object.values(tokens).some(t=>t && t.type==='automation')) process.exit(0); process.exit(1)"; then
            echo "ERROR: NPM_TOKEN does not appear to be an Automation token or lacks permission to list tokens."
            echo "Fix: create an npm Automation token in https://www.npmjs.com/settings/access-tokens and add it to GitHub Secrets as NPM_TOKEN."
            exit 1
          fi

      - name: Set scoped registry for npmjs (if publishing there)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        run: |
          SCOPE=$(node -p 'require("./package.json").name.split("/")[0]')
          if [[ -z "$SCOPE" || "$SCOPE" == "$(node -p 'require("./package.json").name')" ]]; then
            echo "Package is not scoped; skipping scoped registry configuration."
            exit 0
          fi
          if [[ "$SCOPE" != @* ]]; then
            echo "Resolved scope ($SCOPE) does not start with @; skipping scoped registry configuration."
            exit 0
          fi
          echo "Setting ${SCOPE}:registry to $PUBLISH_REGISTRY"
          npm config set "${SCOPE}:registry" "$PUBLISH_REGISTRY"

      - name: Debug npm config and whoami
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        env:
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
          NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}
        run: |
          echo "Global registry:" $(npm config get registry)
          echo "Scoped registry for package name:" $(node -p "require('./package.json').name")
          SCOPE=$(node -p 'require("./package.json").name.split("/")[0]')
          echo "Resolved scope: $SCOPE"
          echo "Registry for $SCOPE:" $(npm config get ${SCOPE}:registry || echo "(none)")
          echo "publishConfig in package.json:"; node -e "console.log(JSON.stringify(require('./package.json').publishConfig || {}, null, 2))"
          echo "Check identity with whoami (registry = $PUBLISH_REGISTRY)"
          npm whoami --registry "$PUBLISH_REGISTRY" || echo "whoami failed"

      - name: Publish to npm registry
        # For scoped packages that use publishConfig in package.json we need to
        # override that setting when publishing to npmjs.org. This step will
        # set the registry in package.json to the desired registry in the
        # manual dispatch case.
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        run: |
          node -e "const p=require('./package.json'); p.publishConfig={registry:'https://registry.npmjs.org/'}; require('fs').writeFileSync('./package.json', JSON.stringify(p, null, 2)); console.log('publishConfig overridden to npmjs');"

      - name: Publish to npm registry (EOTP aware)
        env:
          NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
        run: |
          # Capture output for troubleshooting
          mkdir -p /tmp/npm-publish && npm publish --registry "$PUBLISH_REGISTRY" 2>&1 | tee /tmp/npm-publish/publish.log || true

          status=$?

          # If the publish command failed, diagnose a one-time-password (2FA) error
          if grep -qi "EOTP" /tmp/npm-publish/publish.log; then
            echo "ERROR: npm publish failed because npm requires a one-time password (2FA)."
            echo "To fix: create an npm "Automation" access token on npmjs and add it as the NPM_TOKEN secret."
            echo "See: https://docs.npmjs.com/creating-and-viewing-access-tokens"
            exit 1
          fi

          # Also check for 401 / unauthorized errors
          if grep -qi "401" /tmp/npm-publish/publish.log || grep -qi "Unauthorized" /tmp/npm-publish/publish.log; then
            echo "ERROR: npm publish failed with an authorization error (401)."
            echo "Check that your NPM_TOKEN is present and has publish rights for this package, and that the token is an Automation token (not an OTP-protected interactive token)."
            exit 1
          fi

            # If OIDC is enabled by dispatcher but the trusted publisher is not configured,
            # npm will produce ENEEDAUTH / 'need auth'. Detect that and provide OIDC-specific guidance.
            if grep -qi "ENEEDAUTH" /tmp/npm-publish/publish.log || grep -qi "need auth" /tmp/npm-publish/publish.log || grep -qi "Unable to authenticate" /tmp/npm-publish/publish.log; then
              echo "ERROR: npm publish failed to authenticate."
              echo "This usually means Trusted Publishing (OIDC) is not configured for this repository or workflow on npmjs."
              echo "Fix: go to your package Settings on npmjs.com → Trusted Publisher and add your GitHub repository and workflow filename (publish.yml)."
              echo "Alternatively, use a token by setting NPM_TOKEN in your repository actions secrets and running use_oidc=false when dispatching the workflow."
              exit 1
            fi

          # Otherwise exit with original status
          exit $status
