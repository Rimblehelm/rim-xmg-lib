name: Publish

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      use_npm:
        description: 'Publish to npmjs.org instead of GitHub Packages'
        required: false
        default: 'false'

permissions:
  contents: read
  packages: write

jobs:
  publish:
    name: Publish package to GitHub Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com/'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Determine publish registry/token
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Default to GitHub Packages token
          echo "PUBLISH_REGISTRY=https://npm.pkg.github.com/" >> $GITHUB_ENV
          echo "NODE_AUTH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

          # If this workflow was manually dispatched with use_npm=true, switch to npmjs registry
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.use_npm }}" = "true" ]; then
            if [ -z "$NPM_TOKEN" ]; then
              echo "ERROR: NPM_TOKEN must be set to publish to npmjs.org. Add it in Settings → Secrets and variables → Actions.";
              exit 1;
            fi
            echo "PUBLISH_REGISTRY=https://registry.npmjs.org/" >> $GITHUB_ENV
            echo "NODE_AUTH_TOKEN=$NPM_TOKEN" >> $GITHUB_ENV
          fi

      - name: Configure npm auth for registry
        run: |
          if [ "$PUBLISH_REGISTRY" = "https://registry.npmjs.org/" ]; then
            echo "Configuring npm auth for npmjs.org";
            npm config set //registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN;
          else
            echo "Configuring npm auth for GitHub Packages";
            npm config set //npm.pkg.github.com/:_authToken=$NODE_AUTH_TOKEN;
          fi

      - name: Check NPM token (whoami)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
        run: |
          echo "Checking npm authentication at $PUBLISH_REGISTRY"
          npm whoami --registry "$PUBLISH_REGISTRY" || (echo "ERROR: npm whoami failed — your NPM_TOKEN may be invalid or lack publish access for this package"; exit 1)

      - name: Verify NPM token type is Automation (CI-only)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        env:
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
        run: |
          echo "Verifying NPM token type on $PUBLISH_REGISTRY"
          # npm token list returns tokens for the authenticated user. Ensure the token in use is type 'automation'.
          # We avoid printing the list directly to keep tokens and IDs private.
          if ! npm token list --json --registry "$PUBLISH_REGISTRY" 2>/dev/null | node -e "const fs=require('fs'); const s=fs.readFileSync(0,'utf8'); let tokens=(s?JSON.parse(s):null); if(!tokens) process.exit(1); if(Array.isArray(tokens) && tokens.some(t=>t.type==='automation')) process.exit(0); if(typeof tokens==='object' && Object.values(tokens).some(t=>t && t.type==='automation')) process.exit(0); process.exit(1)"; then
            echo "ERROR: NPM_TOKEN does not appear to be an Automation token or lacks permission to list tokens."
            echo "Fix: create an npm Automation token in https://www.npmjs.com/settings/access-tokens and add it to GitHub Secrets as NPM_TOKEN."
            exit 1
          fi

      - name: Set scoped registry for npmjs (if publishing there)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        run: |
          SCOPE=$(node -p 'require("./package.json").name.split("/")[0]')
          if [[ -z "$SCOPE" || "$SCOPE" == "$(node -p 'require("./package.json").name')" ]]; then
            echo "Package is not scoped; skipping scoped registry configuration."
            exit 0
          fi
          if [[ "$SCOPE" != @* ]]; then
            echo "Resolved scope ($SCOPE) does not start with @; skipping scoped registry configuration."
            exit 0
          fi
          echo "Setting ${SCOPE}:registry to $PUBLISH_REGISTRY"
          npm config set "${SCOPE}:registry" "$PUBLISH_REGISTRY"

      - name: Debug npm config and whoami
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        env:
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
          NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}
        run: |
          echo "Global registry:" $(npm config get registry)
          echo "Scoped registry for package name:" $(node -p "require('./package.json').name")
          SCOPE=$(node -p 'require("./package.json").name.split("/")[0]')
          echo "Resolved scope: $SCOPE"
          echo "Registry for $SCOPE:" $(npm config get ${SCOPE}:registry || echo "(none)")
          echo "publishConfig in package.json:"; node -e "console.log(JSON.stringify(require('./package.json').publishConfig || {}, null, 2))"
          echo "Check identity with whoami (registry = $PUBLISH_REGISTRY)"
          npm whoami --registry "$PUBLISH_REGISTRY" || echo "whoami failed"

      - name: Publish to npm registry
        # For scoped packages that use publishConfig in package.json we need to
        # override that setting when publishing to npmjs.org. This step will
        # set the registry in package.json to the desired registry in the
        # manual dispatch case.
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.use_npm == 'true' }}
        run: |
          node -e "const p=require('./package.json'); p.publishConfig={registry:'https://registry.npmjs.org/'}; require('fs').writeFileSync('./package.json', JSON.stringify(p, null, 2)); console.log('publishConfig overridden to npmjs');"

      - name: Publish to npm registry (EOTP aware)
        env:
          NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}
          PUBLISH_REGISTRY: ${{ env.PUBLISH_REGISTRY }}
        run: |
          # Capture output for troubleshooting
          mkdir -p /tmp/npm-publish && npm publish --registry "$PUBLISH_REGISTRY" 2>&1 | tee /tmp/npm-publish/publish.log || true

          status=$?

          # If the publish command failed, diagnose a one-time-password (2FA) error
          if grep -qi "EOTP" /tmp/npm-publish/publish.log; then
            echo "ERROR: npm publish failed because npm requires a one-time password (2FA)."
            echo "To fix: create an npm "Automation" access token on npmjs and add it as the NPM_TOKEN secret."
            echo "See: https://docs.npmjs.com/creating-and-viewing-access-tokens"
            exit 1
          fi

          # Also check for 401 / unauthorized errors
          if grep -qi "401" /tmp/npm-publish/publish.log || grep -qi "Unauthorized" /tmp/npm-publish/publish.log; then
            echo "ERROR: npm publish failed with an authorization error (401)."
            echo "Check that your NPM_TOKEN is present and has publish rights for this package, and that the token is an Automation token (not an OTP-protected interactive token)."
            exit 1
          fi

          # Otherwise exit with original status
          exit $status
